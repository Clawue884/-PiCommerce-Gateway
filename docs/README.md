# PiCommerce Gateway â€” Developer Documentation

PiCommerce Gateway is an **open-source payment gateway** designed for applications in the **Pi Network ecosystem**.  
It provides a backend API for managing purchase orders and securely handling Pi payment confirmations using webhooks, along with a small frontend helper for interacting with the Pi JavaScript SDK.

> **Project Status:** Alpha  
> This project is under active development. Some features are incomplete or planned for future releases.

---

## Overview

PiCommerce Gateway follows the official **Pi Network A2U (App-to-User)** payment flow.

The backend is responsible for:
- Creating purchase orders
- Verifying payment confirmation webhooks
- Persisting transaction state

The frontend is responsible for:
- Authenticating users with Pi
- Initiating payments using the Pi SDK

The backend **never initiates payments directly**.

---

## High-Level Payment Flow

1. Frontend requests a new purchase order from the backend
2. Backend returns a unique `merchant_ref`
3. Frontend initiates payment using the Pi SDK
4. Pi Platform processes the payment
5. Pi Platform sends a webhook to the backend
6. Backend verifies the webhook signature and updates order status

---

### Create Purchase Order

**HTTP Method:** `POST`  
**URL:** `/purchase_orders`

POST /purchase_orders

**Description**  
Creates a new purchase order that will later be referenced during Pi payment creation.

**Request Body**
```json
{
  "amountPi": 3.14,
  "metadata": {
    "memo": "Order #123"
  }
}

Response
{
  "id": 1,
  "merchant_ref": "PO-ABCD1234XY",
  "amount_pi": 3.14,
  "status": "created",
  "metadata": {
    "memo": "Order #123"
  }
}

Notes:
merchant_ref is generated by the backend
This value must be passed to the Pi SDK when creating a payment

## Pi Webhook Endpoint

Endpoint: POST /webhook/pi

Purpose: Receives payment confirmation events from the Pi Platform.

Security:
Webhook requests are validated using HMAC SHA256
Signature is sent via the X-Pi-Signature header

Example Payload

{
  "event": "payment.completed",
  "paymentId": "pi_payment_123",
  "merchantRef": "PO-ABCD1234XY",
  "status": "paid"
}


When a valid webhook is received:

The purchase order status is updated to paid
The Pi payment ID is stored

## Database Schema
purchase_orders

| Field         | Description                                        |
| ------------- | -------------------------------------------------- |
| id            | Primary key                                        |
| merchant_ref  | Unique merchant reference                          |
| status        | created, pending_payment, paid, settled, cancelled |
| amount_pi     | Payment amount in Pi                               |
| metadata      | Optional JSON metadata                             |
| pi_payment_id | Pi platform payment ID                             |
| created_at    | Timestamp                                          |
| updated_at    | Timestamp                                          |


## Frontend Integration (Pi SDK)
Authentication
await piAuthenticate();

Must be executed inside Pi Browser
Opens the Pi authentication flow


## Create Payment
await piCreatePayment({
  amountPi: 3.14,
  merchantRef: "PO-ABCD1234XY",
  metadata: { memo: "Order #123" }
});


Important:
Payments are created only via the Pi SDK
Backend does not execute payments directly


## Environment Configuration

The backend relies on standard Laravel environment configuration.

Some values (such as the Pi webhook secret) are referenced in code but may not yet
be present in `.env.example`, as the project is currently in alpha.

### Common Variables

```env
DATABASE_URL=
PI_API_KEY=
JWT_SECRET=

## Scope & Limitations

- Backend does not initiate payments
- Payments are created only via Pi SDK
- No admin dashboard included
- Some backend components are still evolving

## Planned Enhancements

- Admin dashboard
- Extended audit logging
- Improved API documentation

## Contributing

Contributions are welcome.  
Please read `CONTRIBUTING.md` before submitting a pull request.
